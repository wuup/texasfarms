<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Texas Farms - The Game</title>
    <style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: #1a2e1a;
    overflow: hidden;
    touch-action: none;
}
#game-container {
    width: 100vw;
    height: 100vh;
    position: relative;
}
canvas {
    display: block;
    image-rendering: pixelated;
}
/* HUD Overlay */
#hud {
    position: absolute;
    top: 10px;
    left: 10px;
    right: 10px;
    display: flex;
    justify-content: space-between;
    pointer-events: none;
    z-index: 100;
}
.hud-panel {
    background: rgba(0,0,0,0.7);
    color: #f7f4ed;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    pointer-events: auto;
}
.hud-panel h3 {
    font-size: 12px;
    color: #b87333;
    margin-bottom: 4px;
    text-transform: uppercase;
}
#money-display { font-size: 20px; font-weight: bold; color: #22c55e; }
#time-display { font-weight: 600; }

/* Dialog Box */
#dialog {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.9);
    color: #f7f4ed;
    padding: 16px 24px;
    border-radius: 12px;
    border: 2px solid #b87333;
    max-width: 600px;
    width: 90%;
    display: none;
    z-index: 200;
}
#dialog.show { display: block; }
#dialog-text { margin-bottom: 12px; line-height: 1.5; }
#dialog-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
#dialog-options button {
    background: #2d4a3e;
    border: 1px solid #b87333;
    color: #f7f4ed;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}
#dialog-options button:hover { background: #3d5a4e; }
#dialog-options button.primary { background: #b87333; }

/* Instructions */
#instructions {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: rgba(0,0,0,0.6);
    color: #aaa;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
}

/* Title Screen */
#title-screen {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, #1a2e1a 0%, #2d4a3e 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 500;
}
#title-screen h1 {
    font-size: 3rem;
    margin-bottom: 0.5rem;
}
#title-screen h2 {
    font-size: 2rem;
    color: #f7f4ed;
    margin-bottom: 0.25rem;
}
#title-screen p {
    color: #b87333;
    font-style: italic;
    margin-bottom: 2rem;
}
#title-screen button {
    background: #b87333;
    border: none;
    color: white;
    padding: 16px 48px;
    font-size: 1.2rem;
    border-radius: 8px;
    cursor: pointer;
    margin: 8px;
}
#title-screen button:hover { background: #d4915c; }

/* Toast */
#toast {
    position: absolute;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    color: #f7f4ed;
    padding: 12px 24px;
    border-radius: 8px;
    display: none;
    z-index: 300;
}
#toast.show { display: block; animation: fadeInOut 3s forwards; }
@keyframes fadeInOut {
    0%, 80% { opacity: 1; }
    100% { opacity: 0; }
}
    </style>
</head>
<body>
<div id="game-container">
    <canvas id="game-canvas"></canvas>

    <div id="hud">
        <div class="hud-panel">
            <h3>Farmer</h3>
            <div id="money-display">$500</div>
        </div>
        <div class="hud-panel">
            <h3>Time</h3>
            <div id="time-display">Day 1, Spring Y1</div>
        </div>
        <div class="hud-panel">
            <h3>Farm</h3>
            <div id="animal-count">0 animals</div>
        </div>
    </div>

    <div id="dialog">
        <div id="dialog-text"></div>
        <div id="dialog-options"></div>
    </div>

    <div id="toast"></div>

    <div id="instructions">
        WASD/Arrows: Move | E/Space: Interact
    </div>

    <div id="title-screen">
        <h1>üåæ</h1>
        <h2>Texas Farms</h2>
        <p>A Vermont Farming Adventure</p>
        <button onclick="Game.start()">Start Game</button>
    </div>
</div>

<script>
// ==========================================
// TEXAS FARMS - THE GAME v0.5.0
// Now with actual gameplay!
// ==========================================

const TILE_SIZE = 48;
const WORLD_WIDTH = 30;
const WORLD_HEIGHT = 20;

// ==========================================
// WORLD MAP - Tile Types
// ==========================================
const TILES = {
    GRASS: 0,
    DIRT_PATH: 1,
    WATER: 2,
    FENCE: 3,
    BARN_FLOOR: 4,
    BARN_WALL: 5,
    TREE: 6,
    FLOWERS: 7,
    HAY: 8,
    TROUGH: 9,
    DOOR: 10,
    MARKET_STALL: 11,
    HOUSE_WALL: 12,
    HOUSE_FLOOR: 13,
};

// Colors for each tile
const TILE_COLORS = {
    [TILES.GRASS]: '#4a7c59',
    [TILES.DIRT_PATH]: '#8b7355',
    [TILES.WATER]: '#4a90d9',
    [TILES.FENCE]: '#8b6914',
    [TILES.BARN_FLOOR]: '#a0522d',
    [TILES.BARN_WALL]: '#8b4513',
    [TILES.TREE]: '#2d5a27',
    [TILES.FLOWERS]: '#4a7c59',
    [TILES.HAY]: '#daa520',
    [TILES.TROUGH]: '#696969',
    [TILES.DOOR]: '#654321',
    [TILES.MARKET_STALL]: '#8b4513',
    [TILES.HOUSE_WALL]: '#deb887',
    [TILES.HOUSE_FLOOR]: '#d2b48c',
};

// Which tiles block movement
const SOLID_TILES = [TILES.WATER, TILES.FENCE, TILES.BARN_WALL, TILES.TREE, TILES.HOUSE_WALL];

// Generate the world map
function generateWorld() {
    const map = [];
    for (let y = 0; y < WORLD_HEIGHT; y++) {
        const row = [];
        for (let x = 0; x < WORLD_WIDTH; x++) {
            row.push(TILES.GRASS);
        }
        map.push(row);
    }

    // Add dirt path from left to right
    for (let x = 0; x < WORLD_WIDTH; x++) {
        map[10][x] = TILES.DIRT_PATH;
        map[11][x] = TILES.DIRT_PATH;
    }
    // Vertical path
    for (let y = 5; y < 15; y++) {
        map[y][15] = TILES.DIRT_PATH;
        map[y][16] = TILES.DIRT_PATH;
    }

    // Add pond
    for (let y = 2; y < 5; y++) {
        for (let x = 2; x < 6; x++) {
            map[y][x] = TILES.WATER;
        }
    }

    // Add trees around edges
    for (let x = 0; x < WORLD_WIDTH; x++) {
        if (Math.random() < 0.4) map[0][x] = TILES.TREE;
        if (Math.random() < 0.4) map[WORLD_HEIGHT-1][x] = TILES.TREE;
    }
    for (let y = 0; y < WORLD_HEIGHT; y++) {
        if (Math.random() < 0.5) map[y][0] = TILES.TREE;
        if (Math.random() < 0.5) map[y][WORLD_WIDTH-1] = TILES.TREE;
    }

    // Add barn (pig barn)
    for (let y = 3; y < 8; y++) {
        for (let x = 20; x < 26; x++) {
            if (y === 3 || y === 7 || x === 20 || x === 25) {
                map[y][x] = TILES.BARN_WALL;
            } else {
                map[y][x] = TILES.BARN_FLOOR;
            }
        }
    }
    map[7][22] = TILES.DOOR; // Barn door
    map[7][23] = TILES.DOOR;

    // Add pig pasture fencing
    for (let x = 19; x < 27; x++) {
        map[9][x] = TILES.FENCE;
        map[14][x] = TILES.FENCE;
    }
    for (let y = 9; y < 15; y++) {
        map[y][19] = TILES.FENCE;
        map[y][26] = TILES.FENCE;
    }
    map[11][19] = TILES.GRASS; // Gate

    // Feed trough in pasture
    map[12][22] = TILES.TROUGH;
    map[12][23] = TILES.TROUGH;

    // Farmhouse
    for (let y = 3; y < 7; y++) {
        for (let x = 8; x < 13; x++) {
            if (y === 3 || y === 6 || x === 8 || x === 12) {
                map[y][x] = TILES.HOUSE_WALL;
            } else {
                map[y][x] = TILES.HOUSE_FLOOR;
            }
        }
    }
    map[6][10] = TILES.DOOR; // House door

    // Market stall at bottom
    for (let x = 10; x < 14; x++) {
        map[16][x] = TILES.MARKET_STALL;
    }

    // Random flowers
    for (let y = 0; y < WORLD_HEIGHT; y++) {
        for (let x = 0; x < WORLD_WIDTH; x++) {
            if (map[y][x] === TILES.GRASS && Math.random() < 0.05) {
                map[y][x] = TILES.FLOWERS;
            }
        }
    }

    return map;
}

// ==========================================
// ENTITIES
// ==========================================

class Player {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.targetX = x;
        this.targetY = y;
        this.speed = 4;
        this.direction = 'down';
        this.moving = false;
        this.sprite = 'üë®‚Äçüåæ';
    }

    update(keys, world, entities) {
        let dx = 0, dy = 0;

        if (keys.up) { dy = -1; this.direction = 'up'; }
        if (keys.down) { dy = 1; this.direction = 'down'; }
        if (keys.left) { dx = -1; this.direction = 'left'; }
        if (keys.right) { dx = 1; this.direction = 'right'; }

        if (dx !== 0 || dy !== 0) {
            this.moving = true;
            const newX = this.x + dx * this.speed;
            const newY = this.y + dy * this.speed;

            // Check collision with world
            const tileX = Math.floor(newX / TILE_SIZE);
            const tileY = Math.floor(newY / TILE_SIZE);

            if (tileX >= 0 && tileX < WORLD_WIDTH && tileY >= 0 && tileY < WORLD_HEIGHT) {
                const tile = world[tileY][tileX];
                if (!SOLID_TILES.includes(tile)) {
                    this.x = newX;
                    this.y = newY;
                }
            }

            // Keep in bounds
            this.x = Math.max(0, Math.min(this.x, (WORLD_WIDTH - 1) * TILE_SIZE));
            this.y = Math.max(0, Math.min(this.y, (WORLD_HEIGHT - 1) * TILE_SIZE));
        } else {
            this.moving = false;
        }
    }

    draw(ctx, camera) {
        const screenX = this.x - camera.x;
        const screenY = this.y - camera.y;

        // Draw shadow
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.beginPath();
        ctx.ellipse(screenX + TILE_SIZE/2, screenY + TILE_SIZE - 5, 15, 8, 0, 0, Math.PI * 2);
        ctx.fill();

        // Draw player emoji
        ctx.font = `${TILE_SIZE - 8}px serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(this.sprite, screenX + TILE_SIZE/2, screenY + TILE_SIZE/2);
    }

    getInteractionPoint() {
        const offsets = {
            up: { x: 0, y: -TILE_SIZE },
            down: { x: 0, y: TILE_SIZE },
            left: { x: -TILE_SIZE, y: 0 },
            right: { x: TILE_SIZE, y: 0 }
        };
        const offset = offsets[this.direction];
        return {
            x: this.x + offset.x,
            y: this.y + offset.y
        };
    }
}

class Animal {
    constructor(x, y, type) {
        this.id = Math.random().toString(36).substr(2, 9);
        this.x = x;
        this.y = y;
        this.type = type;
        this.age = 0;
        this.health = 100;
        this.happiness = 80;
        this.hunger = 0;
        this.weight = type === 'pig' ? 50 : 0.5;
        this.name = this.generateName();
        this.wanderTimer = 0;
        this.wanderDir = { x: 0, y: 0 };
        this.genetics = {
            quality: 0.5 + Math.random() * 0.4,
            growth: 0.6 + Math.random() * 0.4,
        };
    }

    generateName() {
        const pigNames = ['Wilbur', 'Babe', 'Hamlet', 'Porky', 'Truffle', 'Rosie', 'Chester', 'Penny'];
        const rabbitNames = ['Thumper', 'Flopsy', 'Cotton', 'Peter', 'Hazel', 'Clover'];
        const names = this.type === 'pig' ? pigNames : rabbitNames;
        return names[Math.floor(Math.random() * names.length)];
    }

    get sprite() {
        if (this.type === 'pig') {
            if (this.age < 60) return 'üê∑';
            return 'üêñ';
        }
        return 'üê∞';
    }

    get maturityAge() {
        return this.type === 'pig' ? 180 : 90;
    }

    get value() {
        const basePrice = this.type === 'pig' ? 3 : 8;
        return Math.round(this.weight * basePrice * this.genetics.quality);
    }

    update(world) {
        // Random wandering
        this.wanderTimer--;
        if (this.wanderTimer <= 0) {
            this.wanderTimer = 60 + Math.random() * 120;
            if (Math.random() < 0.5) {
                this.wanderDir = { x: 0, y: 0 };
            } else {
                const dirs = [{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];
                this.wanderDir = dirs[Math.floor(Math.random() * dirs.length)];
            }
        }

        if (this.wanderDir.x !== 0 || this.wanderDir.y !== 0) {
            const newX = this.x + this.wanderDir.x * 1;
            const newY = this.y + this.wanderDir.y * 1;

            const tileX = Math.floor(newX / TILE_SIZE);
            const tileY = Math.floor(newY / TILE_SIZE);

            if (tileX >= 0 && tileX < WORLD_WIDTH && tileY >= 0 && tileY < WORLD_HEIGHT) {
                const tile = world[tileY][tileX];
                if (!SOLID_TILES.includes(tile) && tile !== TILES.WATER) {
                    this.x = newX;
                    this.y = newY;
                } else {
                    this.wanderDir = { x: 0, y: 0 };
                }
            }
        }

        // Keep in pasture area (rough bounds)
        this.x = Math.max(20 * TILE_SIZE, Math.min(this.x, 25 * TILE_SIZE));
        this.y = Math.max(10 * TILE_SIZE, Math.min(this.y, 13 * TILE_SIZE));
    }

    draw(ctx, camera) {
        const screenX = this.x - camera.x;
        const screenY = this.y - camera.y;

        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.beginPath();
        ctx.ellipse(screenX + TILE_SIZE/2, screenY + TILE_SIZE - 8, 12, 6, 0, 0, Math.PI * 2);
        ctx.fill();

        // Sprite
        ctx.font = `${TILE_SIZE - 12}px serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(this.sprite, screenX + TILE_SIZE/2, screenY + TILE_SIZE/2);

        // Hunger indicator
        if (this.hunger > 50) {
            ctx.font = '16px serif';
            ctx.fillText('üí≠', screenX + TILE_SIZE - 5, screenY + 10);
        }
    }

    feed() {
        this.hunger = 0;
        this.happiness = Math.min(100, this.happiness + 10);
    }

    advanceDay() {
        this.age++;
        this.hunger += 20;

        // Weight gain if not hungry
        if (this.hunger < 50) {
            const gain = this.type === 'pig' ? 1.5 : 0.15;
            this.weight += gain * this.genetics.growth;
        }

        // Health effects
        if (this.hunger > 80) {
            this.health -= 5;
            this.happiness -= 10;
        }

        this.happiness = Math.max(0, Math.min(100, this.happiness));
        this.health = Math.max(0, Math.min(100, this.health));
    }
}

// ==========================================
// GAME STATE
// ==========================================

const Game = {
    canvas: null,
    ctx: null,
    world: null,
    player: null,
    animals: [],
    camera: { x: 0, y: 0 },
    keys: { up: false, down: false, left: false, right: false, interact: false },
    money: 500,
    day: 1,
    season: 'Spring',
    year: 1,
    dayTimer: 0,
    DAY_LENGTH: 1800, // frames per day (30 seconds at 60fps)
    running: false,
    dialogOpen: false,
    lastInteract: false,

    init() {
        this.canvas = document.getElementById('game-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());

        // Keyboard input
        window.addEventListener('keydown', (e) => this.handleKeyDown(e));
        window.addEventListener('keyup', (e) => this.handleKeyUp(e));

        // Touch controls for mobile
        this.setupTouchControls();
    },

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    },

    handleKeyDown(e) {
        if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') this.keys.up = true;
        if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') this.keys.down = true;
        if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') this.keys.left = true;
        if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') this.keys.right = true;
        if (e.key === 'e' || e.key === 'E' || e.key === ' ') {
            e.preventDefault();
            this.keys.interact = true;
        }
        if (e.key === 'Escape') this.closeDialog();
    },

    handleKeyUp(e) {
        if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') this.keys.up = false;
        if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') this.keys.down = false;
        if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') this.keys.left = false;
        if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') this.keys.right = false;
        if (e.key === 'e' || e.key === 'E' || e.key === ' ') this.keys.interact = false;
    },

    setupTouchControls() {
        let touchStart = null;

        this.canvas.addEventListener('touchstart', (e) => {
            touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        });

        this.canvas.addEventListener('touchmove', (e) => {
            if (!touchStart) return;
            const dx = e.touches[0].clientX - touchStart.x;
            const dy = e.touches[0].clientY - touchStart.y;

            this.keys.left = dx < -20;
            this.keys.right = dx > 20;
            this.keys.up = dy < -20;
            this.keys.down = dy > 20;
        });

        this.canvas.addEventListener('touchend', () => {
            touchStart = null;
            this.keys = { up: false, down: false, left: false, right: false, interact: false };
        });

        // Double tap to interact
        let lastTap = 0;
        this.canvas.addEventListener('touchstart', (e) => {
            const now = Date.now();
            if (now - lastTap < 300) {
                this.keys.interact = true;
                setTimeout(() => this.keys.interact = false, 100);
            }
            lastTap = now;
        });
    },

    start() {
        document.getElementById('title-screen').style.display = 'none';

        // Generate world
        this.world = generateWorld();

        // Create player
        this.player = new Player(10 * TILE_SIZE, 10 * TILE_SIZE);

        // Start with one pig
        this.animals = [];

        this.running = true;
        this.gameLoop();

        this.showToast('Welcome to your farm! Walk to the market stall to buy animals.');
    },

    gameLoop() {
        if (!this.running) return;

        this.update();
        this.render();

        requestAnimationFrame(() => this.gameLoop());
    },

    update() {
        if (this.dialogOpen) return;

        // Update player
        this.player.update(this.keys, this.world, this.animals);

        // Update camera to follow player
        this.camera.x = this.player.x - this.canvas.width / 2 + TILE_SIZE / 2;
        this.camera.y = this.player.y - this.canvas.height / 2 + TILE_SIZE / 2;

        // Keep camera in bounds
        this.camera.x = Math.max(0, Math.min(this.camera.x, WORLD_WIDTH * TILE_SIZE - this.canvas.width));
        this.camera.y = Math.max(0, Math.min(this.camera.y, WORLD_HEIGHT * TILE_SIZE - this.canvas.height));

        // Update animals
        this.animals.forEach(a => a.update(this.world));

        // Day/night cycle
        this.dayTimer++;
        if (this.dayTimer >= this.DAY_LENGTH) {
            this.advanceDay();
        }

        // Handle interactions
        if (this.keys.interact && !this.lastInteract) {
            this.tryInteract();
        }
        this.lastInteract = this.keys.interact;

        // Update HUD
        this.updateHUD();
    },

    advanceDay() {
        this.dayTimer = 0;
        this.day++;

        // Season change every 30 days
        if (this.day > 30) {
            this.day = 1;
            const seasons = ['Spring', 'Summer', 'Fall', 'Winter'];
            const idx = seasons.indexOf(this.season);
            this.season = seasons[(idx + 1) % 4];
            if (this.season === 'Spring') this.year++;
            this.showToast(`${this.season} has arrived!`);
        }

        // Age animals
        this.animals.forEach(a => a.advanceDay());

        // Remove dead animals
        const dead = this.animals.filter(a => a.health <= 0);
        if (dead.length > 0) {
            this.showToast(`${dead.map(a => a.name).join(', ')} died from neglect!`);
        }
        this.animals = this.animals.filter(a => a.health > 0);
    },

    tryInteract() {
        const point = this.player.getInteractionPoint();
        const tileX = Math.floor(point.x / TILE_SIZE);
        const tileY = Math.floor(point.y / TILE_SIZE);

        // Check for animals nearby
        const nearbyAnimal = this.animals.find(a => {
            const ax = Math.floor(a.x / TILE_SIZE);
            const ay = Math.floor(a.y / TILE_SIZE);
            return Math.abs(ax - tileX) <= 1 && Math.abs(ay - tileY) <= 1;
        });

        if (nearbyAnimal) {
            this.showAnimalDialog(nearbyAnimal);
            return;
        }

        // Check tiles
        if (tileX >= 0 && tileX < WORLD_WIDTH && tileY >= 0 && tileY < WORLD_HEIGHT) {
            const tile = this.world[tileY][tileX];

            if (tile === TILES.MARKET_STALL) {
                this.showMarketDialog();
            } else if (tile === TILES.TROUGH) {
                this.feedAnimals();
            } else if (tile === TILES.DOOR && tileX >= 20) {
                this.showBarnDialog();
            } else if (tile === TILES.DOOR && tileX < 15) {
                this.showHouseDialog();
            }
        }
    },

    showMarketDialog() {
        const pigPrice = 200;
        const rabbitPrice = 50;

        let html = '<strong>Market Stall</strong><br><br>';
        html += 'What would you like to do?';

        let options = '';
        if (this.money >= pigPrice) {
            options += `<button onclick="Game.buyAnimal('pig')">Buy Pig ($${pigPrice})</button>`;
        }
        if (this.money >= rabbitPrice) {
            options += `<button onclick="Game.buyAnimal('rabbit')">Buy Rabbit ($${rabbitPrice})</button>`;
        }

        // Sell options
        const matureAnimals = this.animals.filter(a => a.age >= a.maturityAge);
        if (matureAnimals.length > 0) {
            options += `<button onclick="Game.showSellDialog()">Sell Animals (${matureAnimals.length} ready)</button>`;
        }

        options += `<button onclick="Game.closeDialog()">Leave</button>`;

        this.showDialog(html, options);
    },

    showSellDialog() {
        const mature = this.animals.filter(a => a.age >= a.maturityAge);

        let html = '<strong>Sell Animals</strong><br><br>';
        let options = '';

        mature.forEach(a => {
            html += `${a.sprite} ${a.name}: ${Math.round(a.weight)} lbs - $${a.value}<br>`;
            options += `<button onclick="Game.sellAnimal('${a.id}')">Sell ${a.name} ($${a.value})</button>`;
        });

        options += `<button onclick="Game.showMarketDialog()">Back</button>`;

        this.showDialog(html, options);
    },

    showAnimalDialog(animal) {
        let html = `<strong>${animal.sprite} ${animal.name}</strong><br><br>`;
        html += `Age: ${animal.age} days<br>`;
        html += `Weight: ${Math.round(animal.weight * 10) / 10} lbs<br>`;
        html += `Health: ${animal.health}%<br>`;
        html += `Happiness: ${animal.happiness}%<br>`;
        html += `Hunger: ${animal.hunger > 50 ? 'üçñ Hungry!' : 'Fed'}<br>`;
        html += `<br>Value: $${animal.value}`;
        if (animal.age < animal.maturityAge) {
            html += ` (mature in ${animal.maturityAge - animal.age} days)`;
        }

        let options = `<button onclick="Game.petAnimal('${animal.id}')">Pet ${animal.name}</button>`;
        options += `<button onclick="Game.closeDialog()">Close</button>`;

        this.showDialog(html, options);
    },

    showBarnDialog() {
        const pigs = this.animals.filter(a => a.type === 'pig');
        let html = '<strong>üè† Pig Barn</strong><br><br>';
        html += `Pigs: ${pigs.length}<br>`;
        if (pigs.length > 0) {
            const totalWeight = pigs.reduce((sum, p) => sum + p.weight, 0);
            const avgHealth = Math.round(pigs.reduce((sum, p) => sum + p.health, 0) / pigs.length);
            html += `Total Weight: ${Math.round(totalWeight)} lbs<br>`;
            html += `Avg Health: ${avgHealth}%<br>`;
        }

        this.showDialog(html, `<button onclick="Game.closeDialog()">Close</button>`);
    },

    showHouseDialog() {
        let html = '<strong>üè° Farmhouse</strong><br><br>';
        html += `Money: $${this.money}<br>`;
        html += `Animals: ${this.animals.length}<br>`;
        html += `Day ${this.day}, ${this.season} Year ${this.year}<br>`;
        html += '<br><em>Time passes as you explore the farm.</em>';

        let options = `<button onclick="Game.sleep()">Sleep (Skip to next day)</button>`;
        options += `<button onclick="Game.saveGame()">Save Game</button>`;
        options += `<button onclick="Game.closeDialog()">Close</button>`;

        this.showDialog(html, options);
    },

    buyAnimal(type) {
        const price = type === 'pig' ? 200 : 50;
        if (this.money < price) {
            this.showToast("Can't afford that!");
            return;
        }

        this.money -= price;

        // Spawn in pasture
        const x = (21 + Math.random() * 3) * TILE_SIZE;
        const y = (11 + Math.random() * 2) * TILE_SIZE;
        const animal = new Animal(x, y, type);
        this.animals.push(animal);

        this.showToast(`Welcome ${animal.name} to the farm!`);
        this.closeDialog();
    },

    sellAnimal(id) {
        const idx = this.animals.findIndex(a => a.id === id);
        if (idx === -1) return;

        const animal = this.animals[idx];
        this.money += animal.value;
        this.animals.splice(idx, 1);

        this.showToast(`Sold ${animal.name} for $${animal.value}!`);
        this.closeDialog();
    },

    petAnimal(id) {
        const animal = this.animals.find(a => a.id === id);
        if (animal) {
            animal.happiness = Math.min(100, animal.happiness + 5);
            this.showToast(`${animal.name} seems happy!`);
        }
        this.closeDialog();
    },

    feedAnimals() {
        const hungry = this.animals.filter(a => a.hunger > 0);
        if (hungry.length === 0) {
            this.showToast('No animals need feeding!');
            return;
        }

        const cost = hungry.reduce((sum, a) => sum + (a.type === 'pig' ? 5 : 1), 0);

        if (this.money < cost) {
            this.showToast(`Need $${cost} to feed all animals!`);
            return;
        }

        this.money -= cost;
        hungry.forEach(a => a.feed());
        this.showToast(`Fed ${hungry.length} animals for $${cost}!`);
    },

    sleep() {
        this.dayTimer = this.DAY_LENGTH - 1;
        this.showToast('Slept through the night...');
        this.closeDialog();
    },

    saveGame() {
        const save = {
            money: this.money,
            day: this.day,
            season: this.season,
            year: this.year,
            animals: this.animals.map(a => ({
                type: a.type,
                x: a.x,
                y: a.y,
                age: a.age,
                health: a.health,
                happiness: a.happiness,
                hunger: a.hunger,
                weight: a.weight,
                name: a.name,
                genetics: a.genetics
            }))
        };
        localStorage.setItem('texasfarms_save', JSON.stringify(save));
        this.showToast('Game saved!');
    },

    showDialog(text, optionsHTML) {
        document.getElementById('dialog-text').innerHTML = text;
        document.getElementById('dialog-options').innerHTML = optionsHTML;
        document.getElementById('dialog').classList.add('show');
        this.dialogOpen = true;
    },

    closeDialog() {
        document.getElementById('dialog').classList.remove('show');
        this.dialogOpen = false;
    },

    showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.remove('show');
        void toast.offsetWidth; // Trigger reflow
        toast.classList.add('show');
    },

    updateHUD() {
        document.getElementById('money-display').textContent = `$${this.money}`;
        document.getElementById('time-display').textContent = `Day ${this.day}, ${this.season} Y${this.year}`;
        document.getElementById('animal-count').textContent = `${this.animals.length} animals`;
    },

    render() {
        const ctx = this.ctx;
        ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        // Draw world
        for (let y = 0; y < WORLD_HEIGHT; y++) {
            for (let x = 0; x < WORLD_WIDTH; x++) {
                const tile = this.world[y][x];
                const screenX = x * TILE_SIZE - this.camera.x;
                const screenY = y * TILE_SIZE - this.camera.y;

                // Skip if off screen
                if (screenX < -TILE_SIZE || screenX > this.canvas.width ||
                    screenY < -TILE_SIZE || screenY > this.canvas.height) continue;

                // Draw base tile
                ctx.fillStyle = TILE_COLORS[tile] || '#4a7c59';
                ctx.fillRect(screenX, screenY, TILE_SIZE, TILE_SIZE);

                // Draw tile decorations
                ctx.font = `${TILE_SIZE - 8}px serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                if (tile === TILES.TREE) {
                    ctx.fillText('üå≤', screenX + TILE_SIZE/2, screenY + TILE_SIZE/2);
                } else if (tile === TILES.FLOWERS) {
                    ctx.fillText('üå∏', screenX + TILE_SIZE/2, screenY + TILE_SIZE/2);
                } else if (tile === TILES.TROUGH) {
                    ctx.fillStyle = '#555';
                    ctx.fillRect(screenX + 4, screenY + TILE_SIZE - 16, TILE_SIZE - 8, 12);
                } else if (tile === TILES.MARKET_STALL) {
                    ctx.fillText('üè™', screenX + TILE_SIZE/2, screenY + TILE_SIZE/2);
                } else if (tile === TILES.HAY) {
                    ctx.fillText('üåæ', screenX + TILE_SIZE/2, screenY + TILE_SIZE/2);
                }
            }
        }

        // Draw animals (sorted by Y for depth)
        const sortedAnimals = [...this.animals].sort((a, b) => a.y - b.y);
        sortedAnimals.forEach(a => a.draw(ctx, this.camera));

        // Draw player
        this.player.draw(ctx, this.camera);

        // Draw interaction hint
        const point = this.player.getInteractionPoint();
        const tileX = Math.floor(point.x / TILE_SIZE);
        const tileY = Math.floor(point.y / TILE_SIZE);

        if (tileX >= 0 && tileX < WORLD_WIDTH && tileY >= 0 && tileY < WORLD_HEIGHT) {
            const tile = this.world[tileY][tileX];
            if (tile === TILES.MARKET_STALL || tile === TILES.TROUGH || tile === TILES.DOOR) {
                ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                ctx.lineWidth = 2;
                ctx.strokeRect(
                    tileX * TILE_SIZE - this.camera.x + 2,
                    tileY * TILE_SIZE - this.camera.y + 2,
                    TILE_SIZE - 4,
                    TILE_SIZE - 4
                );
            }
        }

        // Check for nearby animals
        const nearbyAnimal = this.animals.find(a => {
            const ax = Math.floor(a.x / TILE_SIZE);
            const ay = Math.floor(a.y / TILE_SIZE);
            return Math.abs(ax - tileX) <= 1 && Math.abs(ay - tileY) <= 1;
        });

        if (nearbyAnimal) {
            ctx.strokeStyle = 'rgba(255,255,0,0.5)';
            ctx.lineWidth = 2;
            ctx.strokeRect(
                Math.floor(nearbyAnimal.x / TILE_SIZE) * TILE_SIZE - this.camera.x + 2,
                Math.floor(nearbyAnimal.y / TILE_SIZE) * TILE_SIZE - this.camera.y + 2,
                TILE_SIZE - 4,
                TILE_SIZE - 4
            );
        }
    }
};

// Initialize on load
window.addEventListener('DOMContentLoaded', () => Game.init());
</script>
</body>
</html>
