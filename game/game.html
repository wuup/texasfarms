<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Texas Farms - The Game</title>
    <meta name="description" content="A cozy farming simulator based on Texas Farms Vermont. Raise heritage Gloucestershire Old Spot pigs, breed for genetics, and survive Vermont winters.">
    <link rel="icon" href="/favicon.ico">
    <style>
/* ========================================
   TEXAS FARMS - THE GAME
   Base Styles & CSS Reset
   ======================================== */

:root {
    --forest: #1a2e1a;
    --forest-light: #2d4a3e;
    --cream: #f7f4ed;
    --cream-dark: #ebe6db;
    --copper: #b87333;
    --copper-light: #d4915c;
    --text: #1a1a1a;
    --text-light: #555;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--forest);
    color: var(--cream);
    min-height: 100vh;
    overflow: hidden;
}

/* ========================================
   GAME CONTAINER
   ======================================== */

#game-container {
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

/* ========================================
   SCREENS
   ======================================== */

.screen {
    display: none;
    width: 100%;
    height: 100%;
    flex-direction: column;
}

.screen.active {
    display: flex;
}

/* Title Screen */
#title-screen {
    justify-content: center;
    align-items: center;
    text-align: center;
    background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
}

.title-logo {
    font-size: 3rem;
    margin-bottom: 0.5rem;
}

.title-name {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    color: var(--cream);
}

.title-subtitle {
    font-size: 1rem;
    color: var(--copper-light);
    margin-bottom: 2rem;
    font-style: italic;
}

.title-buttons {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.btn {
    padding: 1rem 2.5rem;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.btn-primary {
    background: var(--copper);
    color: white;
}

.btn-primary:hover {
    background: var(--copper-light);
    transform: translateY(-2px);
}

.btn-secondary {
    background: transparent;
    color: var(--cream);
    border: 1px solid rgba(255,255,255,0.3);
}

.btn-secondary:hover {
    background: rgba(255,255,255,0.1);
}

/* Game Screen */
#game-screen {
    background: var(--cream);
    color: var(--text);
}

/* HUD */
#hud {
    background: var(--forest);
    color: var(--cream);
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.hud-stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.hud-stat-icon {
    font-size: 1.1rem;
}

.hud-stat-value {
    font-weight: 600;
}

/* Farm View */
#farm-view {
    flex: 1;
    padding: 1rem;
    overflow: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

/* Animals Area */
#animals-area {
    background: #e8e4db;
    border-radius: 8px;
    padding: 1rem;
    min-height: 200px;
}

.animals-title {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-light);
    margin-bottom: 0.75rem;
}

.animals-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.animal-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    min-width: 120px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.2s;
}

.animal-card:hover {
    transform: translateY(-2px);
}

.animal-emoji {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.animal-name {
    font-weight: 600;
    color: var(--forest);
    font-size: 0.9rem;
}

.animal-status {
    font-size: 0.75rem;
    color: var(--text-light);
    margin-top: 0.25rem;
}

.animal-health-bar {
    height: 4px;
    background: #ddd;
    border-radius: 2px;
    margin-top: 0.5rem;
    overflow: hidden;
}

.animal-health-fill {
    height: 100%;
    background: var(--success);
    transition: width 0.3s;
}

/* Actions Bar */
#actions-bar {
    background: var(--forest);
    padding: 1rem;
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.action-btn {
    padding: 0.75rem 1.25rem;
    font-size: 0.85rem;
    background: var(--copper);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.action-btn:hover {
    background: var(--copper-light);
}

.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ========================================
   DEBUG PANEL
   ======================================== */

#debug-toggle {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.75rem;
    z-index: 1000;
}

#debug-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 400px;
    max-width: 90vw;
    height: 100vh;
    background: #1a1a1a;
    color: #f0f0f0;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 999;
    display: flex;
    flex-direction: column;
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.8rem;
}

#debug-panel.open {
    transform: translateX(0);
}

.debug-header {
    background: #2a2a2a;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #333;
}

.debug-header h3 {
    color: var(--copper-light);
}

.debug-close {
    background: none;
    border: none;
    color: #888;
    font-size: 1.5rem;
    cursor: pointer;
}

.debug-tabs {
    display: flex;
    background: #222;
}

.debug-tab {
    flex: 1;
    padding: 0.75rem;
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    border-bottom: 2px solid transparent;
}

.debug-tab.active {
    color: var(--copper-light);
    border-bottom-color: var(--copper);
}

.debug-content {
    flex: 1;
    overflow: auto;
    padding: 1rem;
}

.debug-section {
    margin-bottom: 1.5rem;
}

.debug-section-title {
    color: var(--copper-light);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.5rem;
}

.debug-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.debug-btn {
    padding: 0.5rem 0.75rem;
    background: #333;
    border: 1px solid #444;
    color: #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.75rem;
}

.debug-btn:hover {
    background: #444;
}

.debug-state {
    background: #111;
    padding: 1rem;
    border-radius: 4px;
    overflow: auto;
    max-height: 300px;
    white-space: pre-wrap;
    font-size: 0.7rem;
    line-height: 1.4;
}

.debug-log {
    background: #111;
    padding: 0.5rem;
    border-radius: 4px;
    max-height: 200px;
    overflow: auto;
    font-size: 0.7rem;
}

.log-entry {
    padding: 0.25rem 0;
    border-bottom: 1px solid #222;
}

.log-entry.action { color: #4ade80; }
.log-entry.warning { color: #fbbf24; }
.log-entry.error { color: #f87171; }

/* ========================================
   MODALS
   ======================================== */

.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 100;
}

.modal-overlay.open {
    display: flex;
}

.modal {
    background: var(--cream);
    color: var(--text);
    padding: 2rem;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
    max-height: 80vh;
    overflow: auto;
}

.modal h2 {
    color: var(--forest);
    margin-bottom: 1rem;
}

/* ========================================
   TOAST NOTIFICATIONS
   ======================================== */

#toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 1001;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    pointer-events: none;
}

.toast {
    background: var(--forest);
    color: var(--cream);
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
    min-width: 200px;
    max-width: 350px;
}

.toast.success { border-left: 4px solid var(--success); }
.toast.warning { border-left: 4px solid var(--warning); }
.toast.error { border-left: 4px solid var(--danger); }
.toast.achievement {
    background: linear-gradient(135deg, #1a2e1a 0%, #2d4a3e 100%);
    border-left: 4px solid gold;
}

.toast-icon { font-size: 1.25rem; }
.toast-message { flex: 1; font-size: 0.9rem; }

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; transform: translateX(50%); }
}

/* ========================================
   ACHIEVEMENTS PANEL
   ======================================== */

#achievements-btn {
    position: fixed;
    bottom: 1rem;
    left: 1rem;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.75rem;
    z-index: 1000;
}

.achievements-modal {
    max-width: 500px;
}

.achievement-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: white;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: transform 0.2s;
}

.achievement-item:hover {
    transform: translateX(4px);
}

.achievement-item.locked {
    opacity: 0.5;
    filter: grayscale(1);
}

.achievement-icon {
    font-size: 2rem;
    width: 50px;
    text-align: center;
}

.achievement-info {
    flex: 1;
}

.achievement-name {
    font-weight: 600;
    color: var(--forest);
}

.achievement-desc {
    font-size: 0.8rem;
    color: var(--text-light);
}

.achievement-unlocked {
    color: var(--success);
    font-size: 0.75rem;
    font-weight: 600;
}

/* ========================================
   MONEY ANIMATION
   ======================================== */

.money-change {
    position: absolute;
    font-weight: bold;
    font-size: 1rem;
    animation: floatUp 1s ease-out forwards;
    pointer-events: none;
    z-index: 100;
}

.money-change.positive { color: var(--success); }
.money-change.negative { color: var(--danger); }

@keyframes floatUp {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-30px); opacity: 0; }
}

/* ========================================
   SEASON BACKGROUNDS
   ======================================== */

#farm-view.spring { background: linear-gradient(180deg, #e8f5e9 0%, #c8e6c9 100%); }
#farm-view.summer { background: linear-gradient(180deg, #fff8e1 0%, #ffecb3 100%); }
#farm-view.fall { background: linear-gradient(180deg, #fff3e0 0%, #ffe0b2 100%); }
#farm-view.winter { background: linear-gradient(180deg, #eceff1 0%, #cfd8dc 100%); }

/* ========================================
   ANIMAL ANIMATIONS
   ======================================== */

.animal-card.new {
    animation: pop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes pop {
    0% { transform: scale(0); }
    70% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.animal-card.mature {
    box-shadow: 0 0 0 3px var(--success), 0 4px 15px rgba(34, 197, 94, 0.3);
}

.animal-card.hungry {
    animation: shake 0.5s ease-in-out;
    box-shadow: 0 0 0 2px var(--warning);
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* ========================================
   PROGRESS BAR (in HUD)
   ======================================== */

.hud-progress {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.progress-bar {
    width: 60px;
    height: 6px;
    background: rgba(255,255,255,0.2);
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--copper-light);
    transition: width 0.3s;
}

/* ========================================
   EVENT BANNER
   ======================================== */

#event-banner {
    display: none;
    background: linear-gradient(90deg, var(--copper), var(--copper-light));
    color: white;
    padding: 0.5rem 1rem;
    text-align: center;
    font-size: 0.85rem;
    font-weight: 600;
    animation: pulse 2s infinite;
}

#event-banner.active {
    display: block;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

/* ========================================
   TIPS/HINTS
   ======================================== */

.tip-bubble {
    position: absolute;
    background: var(--forest);
    color: var(--cream);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.85rem;
    max-width: 250px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    animation: bounce 0.5s ease;
    z-index: 50;
}

.tip-bubble::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 20px;
    border-width: 8px 8px 0;
    border-style: solid;
    border-color: var(--forest) transparent transparent;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

/* ========================================
   RESPONSIVE
   ======================================== */

@media (max-width: 600px) {
    .title-name {
        font-size: 2rem;
    }

    #hud {
        font-size: 0.8rem;
        padding: 0.5rem;
    }

    .hud-stat {
        gap: 0.25rem;
    }

    .animal-card {
        min-width: 100px;
        padding: 0.75rem;
    }

    .animal-emoji {
        font-size: 2rem;
    }

    #actions-bar {
        padding: 0.75rem;
        gap: 0.5rem;
    }

    /* Larger touch targets for mobile */
    .action-btn {
        padding: 1rem;
        font-size: 0.9rem;
        min-height: 48px;
        flex: 1 1 calc(50% - 0.5rem);
        justify-content: center;
    }

    .btn {
        padding: 1rem 2rem;
        min-height: 48px;
    }

    #debug-panel {
        width: 100vw;
    }

    .toast {
        min-width: 150px;
        max-width: 280px;
        font-size: 0.8rem;
    }

    #toast-container {
        left: 1rem;
        right: 1rem;
    }

    /* Hide debug by default on mobile, show achievements */
    #debug-toggle {
        display: none;
    }

    #achievements-btn {
        bottom: auto;
        top: auto;
        right: 1rem;
        left: auto;
    }

    /* Better modal on mobile */
    .modal {
        padding: 1.5rem;
        border-radius: 12px 12px 0 0;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-width: 100%;
        width: 100%;
        max-height: 70vh;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }

    .modal-overlay {
        align-items: flex-end;
    }

    /* Farm view improvements */
    #farm-view {
        padding: 0.75rem;
    }

    #animals-area {
        padding: 0.75rem;
    }

    .animals-grid {
        gap: 0.5rem;
    }
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
    /* Styles for touch devices */
    .action-btn:active,
    .btn:active,
    .animal-card:active {
        transform: scale(0.95);
        transition: transform 0.1s;
    }

    .debug-btn {
        padding: 0.75rem 1rem;
        min-height: 44px;
    }
}

/* Landscape mobile */
@media (max-height: 500px) and (orientation: landscape) {
    #hud {
        padding: 0.5rem 1rem;
    }

    #actions-bar {
        padding: 0.5rem;
    }

    .action-btn {
        padding: 0.5rem 1rem;
    }

    #farm-view {
        padding: 0.5rem;
    }
}
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Title Screen -->
        <div id="title-screen" class="screen active">
            <div class="title-logo">üê∑</div>
            <h1 class="title-name">Texas Farms</h1>
            <p class="title-subtitle">The Game</p>
            <div class="title-buttons">
                <button class="btn btn-primary" onclick="Game.newGame()">New Game</button>
                <button class="btn btn-secondary" onclick="Game.loadGame()" id="continue-btn" style="display: none;">Continue</button>
            </div>
            <p style="margin-top: 2rem; font-size: 0.8rem; color: rgba(255,255,255,0.5);">
                A farming simulator based on<br>
                <a href="/home.html" style="color: var(--copper-light);">Texas Farms Vermont</a>
            </p>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <!-- HUD -->
            <div id="hud">
                <div class="hud-stat">
                    <span class="hud-stat-icon">üí∞</span>
                    <span class="hud-stat-value" id="hud-money">$1,000</span>
                </div>
                <div class="hud-stat">
                    <span class="hud-stat-icon">üìÖ</span>
                    <span class="hud-stat-value" id="hud-date">Day 1, Spring Y1</span>
                </div>
                <div class="hud-stat">
                    <span class="hud-stat-icon">üê∑</span>
                    <span class="hud-stat-value" id="hud-animals">0</span>
                </div>
            </div>

            <!-- Farm View -->
            <div id="farm-view">
                <div id="animals-area">
                    <div class="animals-title">Your Animals</div>
                    <div class="animals-grid" id="animals-grid">
                        <!-- Animals render here -->
                    </div>
                </div>
            </div>

            <!-- Actions Bar -->
            <div id="actions-bar">
                <button class="action-btn" onclick="Game.dispatch({type: 'BUY_PIG'})">
                    üê∑ Buy Pig ($200)
                </button>
                <button class="action-btn" onclick="Game.dispatch({type: 'FEED_ALL'})">
                    üåæ Feed All ($5/pig)
                </button>
                <button class="action-btn" onclick="Game.dispatch({type: 'ADVANCE_DAY'})">
                    ‚è≠Ô∏è Next Day
                </button>
                <button class="action-btn" onclick="Game.save()">
                    üíæ Save
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Event Banner -->
    <div id="event-banner"></div>

    <!-- Achievements Button -->
    <button id="achievements-btn" onclick="Achievements.showModal()">üèÜ Achievements</button>

    <!-- Debug Toggle -->
    <button id="debug-toggle" onclick="Debug.toggle()">üîß Debug</button>

    <!-- Debug Panel -->
    <div id="debug-panel">
        <div class="debug-header">
            <h3>üîß Debug Panel</h3>
            <button class="debug-close" onclick="Debug.toggle()">√ó</button>
        </div>
        <div class="debug-tabs">
            <button class="debug-tab active" onclick="Debug.showTab('state')">State</button>
            <button class="debug-tab" onclick="Debug.showTab('controls')">Controls</button>
            <button class="debug-tab" onclick="Debug.showTab('log')">Log</button>
        </div>
        <div class="debug-content">
            <div id="debug-state-tab" class="debug-tab-content">
                <div class="debug-section">
                    <div class="debug-section-title">Game State</div>
                    <pre class="debug-state" id="debug-state-view">Loading...</pre>
                </div>
            </div>
            <div id="debug-controls-tab" class="debug-tab-content" style="display: none;">
                <div class="debug-section">
                    <div class="debug-section-title">Time Controls</div>
                    <div class="debug-controls">
                        <button class="debug-btn" onclick="Debug.advanceDays(1)">+1 Day</button>
                        <button class="debug-btn" onclick="Debug.advanceDays(7)">+7 Days</button>
                        <button class="debug-btn" onclick="Debug.advanceDays(30)">+30 Days</button>
                        <button class="debug-btn" onclick="Debug.advanceDays(90)">+Season</button>
                    </div>
                </div>
                <div class="debug-section">
                    <div class="debug-section-title">Money</div>
                    <div class="debug-controls">
                        <button class="debug-btn" onclick="Debug.addMoney(100)">+$100</button>
                        <button class="debug-btn" onclick="Debug.addMoney(1000)">+$1000</button>
                        <button class="debug-btn" onclick="Debug.addMoney(-100)">-$100</button>
                    </div>
                </div>
                <div class="debug-section">
                    <div class="debug-section-title">Animals</div>
                    <div class="debug-controls">
                        <button class="debug-btn" onclick="Debug.spawnPig()">Spawn Pig</button>
                        <button class="debug-btn" onclick="Debug.spawnAdultPig()">Spawn Adult Pig</button>
                        <button class="debug-btn" onclick="Debug.killAll()">Kill All</button>
                    </div>
                </div>
                <div class="debug-section">
                    <div class="debug-section-title">Data</div>
                    <div class="debug-controls">
                        <button class="debug-btn" onclick="Debug.clearSave()">Clear Save</button>
                        <button class="debug-btn" onclick="Debug.exportState()">Export JSON</button>
                    </div>
                </div>
            </div>
            <div id="debug-log-tab" class="debug-tab-content" style="display: none;">
                <div class="debug-section">
                    <div class="debug-section-title">Action Log</div>
                    <div class="debug-log" id="debug-log">
                        <!-- Log entries here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal-content">
            <!-- Modal content injected here -->
        </div>
    </div>

<script>
/* ========================================
   TEXAS FARMS - THE GAME
   Core Game Engine
   ======================================== */

// ==========================================
// GAME STATE
// ==========================================

const DEFAULT_STATE = {
    meta: {
        version: "0.1.0",
        created: null,
        lastSaved: null,
        totalPlayTime: 0
    },
    farm: {
        name: "My Farm",
        money: 1000,
        day: 1,
        season: "spring",
        year: 1
    },
    animals: [],
    stats: {
        totalAnimalsRaised: 0,
        totalMoneyEarned: 0,
        totalMoneySpent: 0,
        pigsSold: 0
    }
};

// ==========================================
// GAME CONFIG
// ==========================================

const CONFIG = {
    PIG_PRICE: 200,
    FEED_COST_PER_PIG: 5,
    PIG_SELL_PRICE_BASE: 400,
    PIG_MATURITY_DAYS: 180,
    DAYS_PER_SEASON: 30,
    SEASONS: ['spring', 'summer', 'fall', 'winter']
};

// ==========================================
// UTILITY FUNCTIONS
// ==========================================

function generateId() {
    return 'id_' + Math.random().toString(36).substr(2, 9);
}

function deepClone(obj) {
    return JSON.parse(JSON.stringify(obj));
}

function formatMoney(amount) {
    return '$' + amount.toLocaleString();
}

function getSeasonIndex(season) {
    return CONFIG.SEASONS.indexOf(season);
}

function getNextSeason(season) {
    const idx = getSeasonIndex(season);
    return CONFIG.SEASONS[(idx + 1) % 4];
}

function getSeasonIcon(season) {
    const icons = { spring: 'üå∏', summer: '‚òÄÔ∏è', fall: 'üçÇ', winter: '‚ùÑÔ∏è' };
    return icons[season] || 'üìÖ';
}

// ==========================================
// TOAST NOTIFICATION SYSTEM
// ==========================================

const Toast = {
    show(message, type = 'info', icon = null) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icons = {
            success: '‚úÖ',
            warning: '‚ö†Ô∏è',
            error: '‚ùå',
            achievement: 'üèÜ',
            info: '‚ÑπÔ∏è',
            money: 'üí∞',
            pig: 'üê∑'
        };

        toast.innerHTML = `
            <span class="toast-icon">${icon || icons[type] || icons.info}</span>
            <span class="toast-message">${message}</span>
        `;

        container.appendChild(toast);
        Sound.play(type === 'achievement' ? 'achievement' : type === 'success' ? 'success' : 'click');

        // Remove after animation
        setTimeout(() => toast.remove(), 3000);
    },

    success(message) { this.show(message, 'success'); },
    warning(message) { this.show(message, 'warning'); },
    error(message) { this.show(message, 'error'); },
    achievement(message) { this.show(message, 'achievement', 'üèÜ'); }
};

// ==========================================
// SOUND SYSTEM (Web Audio API)
// ==========================================

const Sound = {
    ctx: null,
    enabled: true,

    init() {
        try {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.log('Web Audio not supported');
        }
    },

    play(type) {
        if (!this.enabled || !this.ctx) return;

        // Resume context if suspended (required by browsers)
        if (this.ctx.state === 'suspended') {
            this.ctx.resume();
        }

        const sounds = {
            click: { freq: 800, duration: 0.05, type: 'sine' },
            success: { freq: 523, duration: 0.15, type: 'sine', seq: [523, 659, 784] },
            warning: { freq: 220, duration: 0.2, type: 'sawtooth' },
            error: { freq: 150, duration: 0.3, type: 'square' },
            achievement: { freq: 440, duration: 0.1, type: 'sine', seq: [440, 554, 659, 880] },
            buy: { freq: 300, duration: 0.1, type: 'triangle' },
            sell: { freq: 600, duration: 0.15, type: 'sine', seq: [400, 500, 600] },
            feed: { freq: 350, duration: 0.08, type: 'sine' },
            day: { freq: 440, duration: 0.1, type: 'sine' }
        };

        const sound = sounds[type] || sounds.click;

        if (sound.seq) {
            // Play sequence
            sound.seq.forEach((freq, i) => {
                this.playTone(freq, sound.duration, sound.type, i * sound.duration);
            });
        } else {
            this.playTone(sound.freq, sound.duration, sound.type);
        }
    },

    playTone(freq, duration, type = 'sine', delay = 0) {
        if (!this.ctx) return;

        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();

        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.1, this.ctx.currentTime + delay);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + delay + duration);

        osc.connect(gain);
        gain.connect(this.ctx.destination);

        osc.start(this.ctx.currentTime + delay);
        osc.stop(this.ctx.currentTime + delay + duration);
    }
};

// ==========================================
// ACHIEVEMENTS SYSTEM
// ==========================================

const ACHIEVEMENTS = [
    { id: 'first_pig', name: 'Humble Beginnings', desc: 'Buy your first pig', icon: 'üê∑', check: s => s.stats.totalAnimalsRaised >= 1 },
    { id: 'first_sale', name: 'First Sale!', desc: 'Sell your first pig', icon: 'üí∞', check: s => s.stats.pigsSold >= 1 },
    { id: 'pig_farmer', name: 'Pig Farmer', desc: 'Own 5 pigs at once', icon: 'üêñ', check: s => s.animals.length >= 5 },
    { id: 'survivor', name: 'Survivor', desc: 'Survive your first winter', icon: '‚ùÑÔ∏è', check: s => s.farm.year >= 1 && s.farm.season !== 'winter' || s.farm.year >= 2 },
    { id: 'thousand_dollar', name: 'Thousandaire', desc: 'Have $1,000 at once', icon: 'üíµ', check: s => s.farm.money >= 1000 },
    { id: 'five_thousand', name: 'High Roller', desc: 'Have $5,000 at once', icon: 'üíé', check: s => s.farm.money >= 5000 },
    { id: 'ten_pigs_sold', name: 'Experienced Farmer', desc: 'Sell 10 pigs total', icon: 'üåü', check: s => s.stats.pigsSold >= 10 },
    { id: 'year_one', name: 'Year One Complete', desc: 'Complete your first full year', icon: 'üìÖ', check: s => s.farm.year >= 2 },
    { id: 'heritage_breeder', name: 'Heritage Breeder', desc: 'Raise 20 pigs total', icon: 'üèÜ', check: s => s.stats.totalAnimalsRaised >= 20 },
    { id: 'wealthy_farmer', name: 'Wealthy Farmer', desc: 'Earn $10,000 total', icon: 'üëë', check: s => s.stats.totalMoneyEarned >= 10000 }
];

const Achievements = {
    unlocked: new Set(),

    init() {
        // Load from localStorage
        const saved = localStorage.getItem('texasfarms_achievements');
        if (saved) {
            this.unlocked = new Set(JSON.parse(saved));
        }
    },

    check(state) {
        if (!state) return;

        ACHIEVEMENTS.forEach(achievement => {
            if (!this.unlocked.has(achievement.id) && achievement.check(state)) {
                this.unlock(achievement);
            }
        });
    },

    unlock(achievement) {
        this.unlocked.add(achievement.id);
        this.save();
        Toast.achievement(`Achievement Unlocked: ${achievement.name}!`);
        Sound.play('achievement');
    },

    save() {
        localStorage.setItem('texasfarms_achievements', JSON.stringify([...this.unlocked]));
    },

    showModal() {
        const modal = document.getElementById('modal-content');
        modal.innerHTML = `
            <h2>üèÜ Achievements</h2>
            <p style="color: var(--text-light); margin-bottom: 1rem;">
                ${this.unlocked.size} / ${ACHIEVEMENTS.length} unlocked
            </p>
            <div class="achievements-list">
                ${ACHIEVEMENTS.map(a => `
                    <div class="achievement-item ${this.unlocked.has(a.id) ? '' : 'locked'}">
                        <div class="achievement-icon">${a.icon}</div>
                        <div class="achievement-info">
                            <div class="achievement-name">${a.name}</div>
                            <div class="achievement-desc">${a.desc}</div>
                            ${this.unlocked.has(a.id) ? '<div class="achievement-unlocked">‚úì Unlocked</div>' : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
            <div style="margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="Game.closeModal()">Close</button>
            </div>
        `;
        document.getElementById('modal-overlay').classList.add('open');
    }
};

// ==========================================
// ANIMAL FACTORY
// ==========================================

function createPig(name = null) {
    const names = ['Wilbur', 'Babe', 'Porky', 'Hamlet', 'Petunia', 'Spot', 'Chester', 'Rosie'];
    return {
        id: generateId(),
        type: 'gos_pig',
        name: name || names[Math.floor(Math.random() * names.length)],
        age: 0,
        health: 100,
        happiness: 80,
        fed: true,
        daysSinceFed: 0,
        genetics: {
            marbling: 0.5 + Math.random() * 0.3,
            growthRate: 0.5 + Math.random() * 0.3,
            size: 0.5 + Math.random() * 0.3
        }
    };
}

// ==========================================
// REDUCERS (State Mutations)
// ==========================================

function reduce(state, action) {
    const newState = deepClone(state);

    switch (action.type) {
        case 'BUY_PIG': {
            if (newState.farm.money < CONFIG.PIG_PRICE) {
                Toast.warning("Can't afford a pig! Need $200");
                Sound.play('error');
                Debug.log('Cannot afford pig!', 'warning');
                return state;
            }
            const pig = createPig();
            pig.isNew = true; // Flag for animation
            newState.animals.push(pig);
            newState.farm.money -= CONFIG.PIG_PRICE;
            newState.stats.totalMoneySpent += CONFIG.PIG_PRICE;
            newState.stats.totalAnimalsRaised++;
            Toast.show(`Welcome ${pig.name} to the farm!`, 'success', 'üê∑');
            Sound.play('buy');
            Debug.log(`Bought pig: ${pig.name}`, 'action');
            return newState;
        }

        case 'SELL_PIG': {
            const idx = newState.animals.findIndex(a => a.id === action.id);
            if (idx === -1) return state;

            const pig = newState.animals[idx];
            const price = Math.floor(CONFIG.PIG_SELL_PRICE_BASE * pig.genetics.size * (pig.age / CONFIG.PIG_MATURITY_DAYS));

            newState.animals.splice(idx, 1);
            newState.farm.money += price;
            newState.stats.totalMoneyEarned += price;
            newState.stats.pigsSold++;
            Toast.success(`Sold ${pig.name} for ${formatMoney(price)}!`);
            Sound.play('sell');
            Debug.log(`Sold ${pig.name} for ${formatMoney(price)}`, 'action');
            return newState;
        }

        case 'FEED_ALL': {
            const pigCount = newState.animals.filter(a => a.type === 'gos_pig').length;
            const cost = pigCount * CONFIG.FEED_COST_PER_PIG;

            if (pigCount === 0) {
                Toast.show("No pigs to feed!", 'info', 'üåæ');
                return state;
            }

            if (newState.farm.money < cost) {
                Toast.warning(`Need ${formatMoney(cost)} to feed all pigs!`);
                Sound.play('error');
                Debug.log('Cannot afford to feed all pigs!', 'warning');
                return state;
            }

            newState.farm.money -= cost;
            newState.stats.totalMoneySpent += cost;
            newState.animals.forEach(a => {
                if (a.type === 'gos_pig') {
                    a.fed = true;
                    a.daysSinceFed = 0;
                    a.happiness = Math.min(100, a.happiness + 5);
                }
            });
            Toast.show(`Fed ${pigCount} pig${pigCount > 1 ? 's' : ''} (${formatMoney(cost)})`, 'success', 'üåæ');
            Sound.play('feed');
            Debug.log(`Fed ${pigCount} pigs for ${formatMoney(cost)}`, 'action');
            return newState;
        }

        case 'ADVANCE_DAY': {
            const prevSeason = newState.farm.season;
            newState.farm.day++;

            // Check season change
            if (newState.farm.day > CONFIG.DAYS_PER_SEASON) {
                newState.farm.day = 1;
                newState.farm.season = getNextSeason(newState.farm.season);
                if (newState.farm.season === 'spring') {
                    newState.farm.year++;
                    Toast.achievement(`Year ${newState.farm.year - 1} Complete!`);
                }
                Toast.show(`${newState.farm.season.charAt(0).toUpperCase() + newState.farm.season.slice(1)} has arrived!`, 'info', getSeasonIcon(newState.farm.season));
                Debug.log(`Season changed to ${newState.farm.season}`, 'action');
            }

            // Track deaths for notification
            const deathList = [];

            // Age and process animals
            newState.animals.forEach(animal => {
                animal.age++;
                animal.isNew = false; // Clear new flag
                animal.fed = false;
                animal.daysSinceFed++;

                // Check for maturity milestone
                if (animal.age === CONFIG.PIG_MATURITY_DAYS) {
                    Toast.success(`${animal.name} is now ready to sell!`);
                }

                // Hunger effects
                if (animal.daysSinceFed > 1) {
                    animal.health -= 5;
                    animal.happiness -= 10;
                }

                // Death check
                if (animal.health <= 0) {
                    deathList.push(animal.name);
                    Debug.log(`${animal.name} died from neglect!`, 'error');
                }
            });

            // Notify about deaths
            if (deathList.length > 0) {
                Toast.error(`${deathList.join(', ')} died from neglect!`);
                Sound.play('error');
            }

            // Remove dead animals
            newState.animals = newState.animals.filter(a => a.health > 0);

            // Check for hungry pigs warning
            const hungryPigs = newState.animals.filter(a => a.daysSinceFed > 0 && a.health < 80);
            if (hungryPigs.length > 0 && newState.farm.day % 3 === 0) {
                Toast.warning(`${hungryPigs.length} pig${hungryPigs.length > 1 ? 's are' : ' is'} getting hungry!`);
            }

            Sound.play('day');
            Debug.log(`Advanced to Day ${newState.farm.day}`, 'action');
            return newState;
        }

        case 'ADD_MONEY': {
            newState.farm.money += action.amount;
            return newState;
        }

        case 'SPAWN_PIG': {
            const pig = createPig();
            if (action.age) pig.age = action.age;
            newState.animals.push(pig);
            newState.stats.totalAnimalsRaised++;
            return newState;
        }

        case 'KILL_ALL': {
            newState.animals = [];
            return newState;
        }

        default:
            return state;
    }
}

// ==========================================
// GAME OBJECT
// ==========================================

const Game = {
    state: null,

    init() {
        // Initialize subsystems
        Sound.init();
        Achievements.init();

        // Check for saved game
        const saved = localStorage.getItem('texasfarms_save');
        if (saved) {
            document.getElementById('continue-btn').style.display = 'block';
        }
    },

    newGame() {
        this.state = deepClone(DEFAULT_STATE);
        this.state.meta.created = Date.now();
        this.showScreen('game-screen');
        this.render();
        Toast.show('Welcome to Texas Farms! Buy your first pig to get started.', 'info', 'üè†');
        Debug.log('New game started', 'action');
    },

    loadGame() {
        const saved = localStorage.getItem('texasfarms_save');
        if (saved) {
            try {
                this.state = JSON.parse(saved);
                this.showScreen('game-screen');
                this.render();
                Toast.success('Game loaded!');
                Debug.log('Game loaded', 'action');
            } catch (e) {
                Debug.log('Failed to load save', 'error');
                this.newGame();
            }
        }
    },

    save() {
        if (!this.state) return;
        this.state.meta.lastSaved = Date.now();
        localStorage.setItem('texasfarms_save', JSON.stringify(this.state));
        Toast.show('Game saved!', 'success', 'üíæ');
        Debug.log('Game saved', 'action');
    },

    dispatch(action) {
        if (!this.state) return;
        const prevMoney = this.state.farm.money;
        this.state = reduce(this.state, action);
        this.render();

        // Show money change animation
        const moneyDiff = this.state.farm.money - prevMoney;
        if (moneyDiff !== 0) {
            this.showMoneyChange(moneyDiff);
        }

        // Check achievements after every action
        Achievements.check(this.state);

        Debug.updateStateView();
    },

    showMoneyChange(amount) {
        const el = document.createElement('div');
        el.className = `money-change ${amount > 0 ? 'positive' : 'negative'}`;
        el.textContent = `${amount > 0 ? '+' : ''}${formatMoney(amount)}`;
        el.style.left = '50%';
        el.style.top = '60px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    },

    showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    },

    render() {
        if (!this.state) return;

        // Update HUD
        document.getElementById('hud-money').textContent = formatMoney(this.state.farm.money);
        document.getElementById('hud-date').textContent =
            `Day ${this.state.farm.day}, ${this.state.farm.season.charAt(0).toUpperCase() + this.state.farm.season.slice(1)} Y${this.state.farm.year}`;
        document.getElementById('hud-animals').textContent = this.state.animals.length;

        // Apply season background
        const farmView = document.getElementById('farm-view');
        farmView.className = '';
        farmView.classList.add(this.state.farm.season);

        // Render animals
        const grid = document.getElementById('animals-grid');
        grid.innerHTML = '';

        if (this.state.animals.length === 0) {
            grid.innerHTML = '<p style="color: #888; font-style: italic;">No animals yet. Buy your first pig!</p>';
        } else {
            this.state.animals.forEach(animal => {
                const card = document.createElement('div');
                const isMature = animal.age >= CONFIG.PIG_MATURITY_DAYS;
                const isHungry = animal.daysSinceFed > 1;

                // Build class list
                let cardClasses = 'animal-card';
                if (animal.isNew) cardClasses += ' new';
                if (isMature) cardClasses += ' mature';
                if (isHungry) cardClasses += ' hungry';
                card.className = cardClasses;

                card.onclick = () => this.showAnimalModal(animal);

                const status = isMature ? '‚úÖ Ready to sell' : `${animal.age}/${CONFIG.PIG_MATURITY_DAYS} days`;
                const emoji = animal.fed ? 'üê∑' : (isHungry ? 'üê∑üò´' : 'üê∑üí§');

                card.innerHTML = `
                    <div class="animal-emoji">${emoji}</div>
                    <div class="animal-name">${animal.name}</div>
                    <div class="animal-status">${status}</div>
                    <div class="animal-health-bar">
                        <div class="animal-health-fill" style="width: ${animal.health}%; background: ${animal.health > 50 ? 'var(--success)' : animal.health > 25 ? 'var(--warning)' : 'var(--danger)'}"></div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
    },

    showAnimalModal(animal) {
        const isMature = animal.age >= CONFIG.PIG_MATURITY_DAYS;
        const sellPrice = Math.floor(CONFIG.PIG_SELL_PRICE_BASE * animal.genetics.size * (animal.age / CONFIG.PIG_MATURITY_DAYS));

        const modal = document.getElementById('modal-content');
        modal.innerHTML = `
            <h2>üê∑ ${animal.name}</h2>
            <p><strong>Age:</strong> ${animal.age} days</p>
            <p><strong>Health:</strong> ${animal.health}%</p>
            <p><strong>Happiness:</strong> ${animal.happiness}%</p>
            <p><strong>Fed today:</strong> ${animal.fed ? 'Yes' : 'No'}</p>
            <hr style="margin: 1rem 0; border: none; border-top: 1px solid #ddd;">
            <p><strong>Genetics:</strong></p>
            <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
                <li>Marbling: ${Math.round(animal.genetics.marbling * 100)}%</li>
                <li>Growth Rate: ${Math.round(animal.genetics.growthRate * 100)}%</li>
                <li>Size: ${Math.round(animal.genetics.size * 100)}%</li>
            </ul>
            <p><strong>Sell Price:</strong> ${formatMoney(sellPrice)} ${isMature ? '‚úÖ' : '(not mature)'}</p>
            <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="Game.dispatch({type: 'SELL_PIG', id: '${animal.id}'}); Game.closeModal();" ${!isMature ? 'disabled' : ''}>
                    Sell for ${formatMoney(sellPrice)}
                </button>
                <button class="btn btn-secondary" onclick="Game.closeModal()">Close</button>
            </div>
        `;
        document.getElementById('modal-overlay').classList.add('open');
    },

    closeModal() {
        document.getElementById('modal-overlay').classList.remove('open');
    }
};

// ==========================================
// DEBUG PANEL
// ==========================================

const Debug = {
    logs: [],

    toggle() {
        document.getElementById('debug-panel').classList.toggle('open');
        this.updateStateView();
    },

    showTab(tabName) {
        document.querySelectorAll('.debug-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.debug-tab-content').forEach(t => t.style.display = 'none');

        event.target.classList.add('active');
        document.getElementById(`debug-${tabName}-tab`).style.display = 'block';
    },

    updateStateView() {
        if (Game.state) {
            document.getElementById('debug-state-view').textContent = JSON.stringify(Game.state, null, 2);
        }
    },

    log(message, type = 'info') {
        const entry = { time: new Date().toLocaleTimeString(), message, type };
        this.logs.unshift(entry);
        if (this.logs.length > 100) this.logs.pop();

        const logEl = document.getElementById('debug-log');
        logEl.innerHTML = this.logs.map(l =>
            `<div class="log-entry ${l.type}">[${l.time}] ${l.message}</div>`
        ).join('');
    },

    advanceDays(n) {
        for (let i = 0; i < n; i++) {
            Game.dispatch({ type: 'ADVANCE_DAY' });
        }
    },

    addMoney(amount) {
        Game.dispatch({ type: 'ADD_MONEY', amount });
    },

    spawnPig() {
        Game.dispatch({ type: 'SPAWN_PIG' });
    },

    spawnAdultPig() {
        Game.dispatch({ type: 'SPAWN_PIG', age: CONFIG.PIG_MATURITY_DAYS });
    },

    killAll() {
        Game.dispatch({ type: 'KILL_ALL' });
    },

    clearSave() {
        localStorage.removeItem('texasfarms_save');
        this.log('Save cleared', 'warning');
    },

    exportState() {
        const blob = new Blob([JSON.stringify(Game.state, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'texasfarms-save.json';
        a.click();
    }
};

// ==========================================
// PLAYTEST API (For automated testing)
// ==========================================

const Playtest = {
    // Run a scenario and return results
    async run(scenario) {
        const game = deepClone(DEFAULT_STATE);
        const metrics = {
            startMoney: game.farm.money,
            actions: [],
            checkpoints: []
        };

        // Apply start state if provided
        if (scenario.startState) {
            Object.assign(game, scenario.startState);
        }

        // Run actions
        for (const action of scenario.actions) {
            const before = game.farm.money;
            const result = reduce(game, action);
            Object.assign(game, result);
            metrics.actions.push({
                action: action.type,
                moneyBefore: before,
                moneyAfter: game.farm.money
            });
        }

        return {
            finalState: game,
            metrics: {
                ...metrics,
                finalMoney: game.farm.money,
                daysPlayed: game.farm.day,
                animalsAlive: game.animals.length,
                moneyDelta: game.farm.money - metrics.startMoney
            },
            passed: scenario.validate ? scenario.validate(game) : true
        };
    }
};

// ==========================================
// INIT
// ==========================================

document.addEventListener('DOMContentLoaded', () => {
    Game.init();
});

// Close modal on overlay click
document.getElementById('modal-overlay').addEventListener('click', (e) => {
    if (e.target.id === 'modal-overlay') {
        Game.closeModal();
    }
});
</script>
</body>
</html>
